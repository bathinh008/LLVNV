<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C·ªîNG NH√ÇN VI√äN</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    /* CSS GI·ªÆ NGUY√äN NH∆Ø C≈® */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
    .header { background: #0078d4; color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .header h2 { margin: 0; font-size: 22px; }
    .header p { margin: 5px 0 0; opacity: 0.9; }
    .btn-logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px; font-size: 12px; }
    
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
    .card h4 { margin: 0 0 5px; color: #666; font-size: 14px; }
    .card .value { font-size: 24px; font-weight: bold; color: #333; }
    .card.old { border-bottom: 3px solid #f1c40f; }
    .card.new { border-bottom: 3px solid #2ecc71; }
    
    .action-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px; }
    .action-box h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #0078d4; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #444; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    
    .date-row { display: flex; gap: 15px; }
    .date-col { flex: 1; }

    .source-list-container { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; background: white; }
    .source-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    .source-item:last-child { border-bottom: none; }
    .source-item:hover { background: #f9f9f9; }
    .source-item input { margin-right: 10px; transform: scale(1.2); cursor: pointer; }
    .source-info { display: flex; flex-direction: column; }
    .source-date { font-weight: bold; color: #2c3e50; font-size: 14px; }
    .source-val { font-size: 12px; color: #27ae60; font-weight: 600; }
    
    .source-summary { margin-top: 5px; font-size: 13px; font-weight: bold; text-align: right; }
    .status-ok { color: #27ae60; }
    .status-lack { color: #e74c3c; }

    .calc-info { background: #f0f9ff; padding: 10px; border-radius: 8px; color: #0078d4; font-size: 14px; margin-bottom: 15px; border: 1px dashed #0078d4; display: none; }

    .btn-submit { width: 100%; padding: 12px; background: #0078d4; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-submit:active { transform: scale(0.98); }
    
    .history-list { list-style: none; padding: 0; }
    .history-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #ddd; }
    .history-item.st-Cho { border-left-color: #f39c12; }
    .history-item.st-Duyet { border-left-color: #2ecc71; }
    .history-item.st-TuChoi { border-left-color: #e74c3c; }
    .h-date { font-weight: bold; display: block; }
    .h-type { font-size: 12px; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; margin-left: 5px;}
    .h-status { font-size: 12px; font-weight: bold; color: #888; }
    .btn-cancel { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 5px; }
    
    #loading { text-align: center; padding: 20px; color: #666; display: none; }
</style>
</head>
<body>

<div id="loginScreen" style="height: 100vh; display: flex; align-items: center; justify-content: center; background: #eef2f5;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h2 style="color: #0078d4;">C·ªîNG NH√ÇN VI√äN</h2>
        <input type="text" id="usernameInput" class="form-control" placeholder="Nh·∫≠p M√£ Nh√¢n Vi√™n (VD: NV01)" style="margin-bottom: 15px;" onkeypress="handleEnter(event)">
        <button onclick="doLogin()" class="btn-submit">Truy C·∫≠p</button>
    </div>
</div>

<div id="mainScreen" style="display: none;">
    <div class="header">
        <h2 id="dispName">ƒêang t·∫£i...</h2>
        <p id="dispRole">...</p>
        <button class="btn-logout" onclick="logout()">Tho√°t</button>
    </div>

    <div class="container">
        <h3 style="margin-top:0; color: #444;">S·ªë D∆∞ ph√©p/b√π NƒÉm <span id="currentYearDisp"></span></h3>
        <div class="balance-grid">
            <!-- <div class="card old"> <h4 id="lblPOld">Ph√©p NƒÉm C≈©</h4> <div class="value" id="valPOld">-</div> </div>
            <div class="card new"> <h4 id="lblPNew">Ph√©p NƒÉm M·ªõi</h4> <div class="value" id="valPNew">-</div> </div>
            <div class="card old"> <h4 id="lblBOld">Ngh·ªâ B√π C≈©</h4> <div class="value" id="valBOld">-</div> </div>
            <div class="card new"> <h4 id="lblBNew">Ngh·ªâ B√π M·ªõi</h4> <div class="value" id="valBNew">-</div> </div> -->
			<div class="card old" id="cardPOld"> <h4 id="lblPOld">Ph√©p NƒÉm C≈©</h4> <div class="value" id="valPOld">-</div> </div>
			<div class="card new"> <h4 id="lblPNew">Ph√©p NƒÉm M·ªõi</h4> <div class="value" id="valPNew">-</div> </div>
			<div class="card old" id="cardBOld"> <h4 id="lblBOld">Ngh·ªâ B√π C≈©</h4> <div class="value" id="valBOld">-</div> </div>
			<div class="card new"> <h4 id="lblBNew">Ngh·ªâ B√π M·ªõi</h4> <div class="value" id="valBNew">-</div> </div>
            <div class="card" style="grid-column: span 2; background: #fff3cd; border-bottom: none;">
                <h4 style="color: #d35400;">T·ªîNG PH√âP/B√ô C√ì TH·ªÇ S·ª¨ D·ª§NG</h4> <div class="value" id="valTotal" style="color: #d35400;">-</div>
            </div>
        </div>

        <div class="action-box">
            <h3>üìÖ ƒêƒÉng K√Ω Ngh·ªâ</h3>
            
            <div class="form-group">
                <label>Lo·∫°i ngh·ªâ</label>
                <select id="reqType" class="form-control" onchange="calcTotalDays()">
                    <option value="P">Ngh·ªâ Ph√©p (1.0 ng√†y)</option>
                    <option value="P/2">Ngh·ªâ Ph√©p 0.5 (S√°ng/Chi·ªÅu)</option>
                    <option value="NB">Ngh·ªâ B√π (1.0 ng√†y)</option>
                    <option value="NB/2">Ngh·ªâ B√π 0.5 (S√°ng/Chi·ªÅu)</option>
                </select>
            </div>

            <div class="form-group" id="groupNbSource" style="display:none; background: #e8f0fe; padding: 15px; border-radius: 8px;">
                <label style="color:#1967d2; font-size: 14px; margin-bottom:10px;">Ch·ªçn ngu·ªìn c√¥ng ƒë·ªÉ b√π (B·∫Øt bu·ªôc ph·∫£i <b>B·∫∞NG</b> s·ªë ng√†y ngh·ªâ):</label>
                <div id="sourceList" class="source-list-container"><div style="padding:10px; text-align:center;">ƒêang t·∫£i...</div></div>
                <div id="sourceSummary" class="source-summary status-lack">...</div>
            </div>

            <div class="form-group">
                <div class="date-row">
                    <div class="date-col">
                        <label>T·ª´ ng√†y</label>
                        <input type="date" id="reqStartDate" class="form-control" onchange="calcTotalDays()">
                    </div>
                    <div class="date-col">
                        <label>ƒê·∫øn ng√†y</label>
                        <input type="date" id="reqEndDate" class="form-control" onchange="calcTotalDays()">
                    </div>
                </div>
            </div>
            
            <div id="calcInfo" class="calc-info"></div>

            <div class="form-group">
                <label>L√Ω do / Ghi ch√∫</label>
                <input type="text" id="reqReason" class="form-control" placeholder="Nh·∫≠p l√Ω do (VD: V·ªÅ qu√™, ƒê√°m c∆∞·ªõi...)">
            </div>
            
            <button onclick="submitRequest()" class="btn-submit">G·ª≠i Y√™u C·∫ßu</button>
        </div>

        <h3 style="color: #444;">L·ªãch s·ª≠ y√™u c·∫ßu</h3>
		<ul id="historyList" class="history-list"></ul>

		<div id="viewMoreContainer" style="text-align: center; margin-bottom: 20px; display: none;">
			<button onclick="renderHistory(globalHistoryData, true)" style="background: white; border: 1px solid #0078d4; color: #0078d4; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px;">
				‚Üì Xem to√†n b·ªô l·ªãch s·ª≠ c≈© h∆°n
			</button>
		</div>
			</div>
		</div>

<div id="loading">ƒêang x·ª≠ l√Ω...</div>

<script>
    const SUPABASE_URL = 'https://renqusdcczlhrglbclhe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlbnF1c2RjY3psaHJnbGJjbGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMTIyMzUsImV4cCI6MjA4MDU4ODIzNX0.kF960FS-VvAM2rkNo9kVHfmGAkpwrmlZ5Vf9-QFiC2E';
    
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // BI·∫æN L∆ØU TR·ªÆ T·∫†M
    let globalNeededTotal = 0; // T·ªïng s·ªë c√¥ng c·∫ßn
	let globalHistoryData = []; // [TH√äM M·ªöI] Bi·∫øn l∆∞u full l·ªãch s·ª≠

    // --- KH·ªûI T·∫†O ---
    const savedUser = sessionStorage.getItem("empUser");
    if (savedUser) {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainScreen").style.display = "block";
        loadData(savedUser);
        setupRealtimeListener(savedUser);
    }

    function handleEnter(e) { if (e.key === "Enter") doLogin(); }

    async function doLogin() {
        const userCode = document.getElementById("usernameInput").value.trim().toUpperCase();
        if (!userCode) return alert("Vui l√≤ng nh·∫≠p m√£!");

        document.getElementById("loading").style.display = "block";
        
        // [THAY ƒê·ªîI] L·∫•y th√™m c·ªôt 'status' v√† 'name'
        const { data, error } = await _supabase
            .from('employees')
            .select('code, name, status') // L·∫•y th√™m status
            .eq('code', userCode)
            .single();
            
        document.getElementById("loading").style.display = "none";

        if (error || !data) { 
            alert("M√£ nh√¢n vi√™n kh√¥ng t·ªìn t·∫°i!"); 
            return; 
        }

        // [TH√äM M·ªöI] Ki·ªÉm tra tr·∫°ng th√°i ho·∫°t ƒë·ªông
        if (data.status === 'inactive') {
            alert(`T√†i kho·∫£n c·ªßa nh√¢n vi√™n ${data.name} ƒë√£ b·ªã v√¥ hi·ªáu h√≥a (ƒê√£ ngh·ªâ vi·ªác).`);
            return;
        }

        sessionStorage.setItem("empUser", userCode);
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainScreen").style.display = "block";
        loadData(userCode);
        setupRealtimeListener(userCode);
    }

    function logout() {
        sessionStorage.removeItem("empUser");
        location.reload();
    }

    // --- T·∫¢I D·ªÆ LI·ªÜU ---
    // --- T·∫¢I D·ªÆ LI·ªÜU (ƒê√É C·∫¨P NH·∫¨T LOGIC H·∫æT H·∫†N) ---
    async function loadData(userCode) {
        document.getElementById("loading").style.display = "block";
        try {
            // B∆Ø·ªöC 1: L·∫•y tu·∫ßn l√†m vi·ªác m·ªõi nh·∫•t
            const weekRes = await _supabase.from('weeks')
                .select('week_start')
                .eq('group_name', 'Gia d·ª•ng') 
                .order('week_start', { ascending: false })
                .limit(1)
                .single();

            // X√°c ƒë·ªãnh ng√†y hi·ªán t·∫°i c·ªßa h·ªá th·ªëng v√† NƒÉm m·ª•c ti√™u
            let systemCurrentDate = new Date(); 
            let targetYear = new Date().getFullYear(); 

            if (weekRes.data && weekRes.data.week_start) {
                systemCurrentDate = new Date(weekRes.data.week_start); // Ng√†y m·ªëc ƒë·ªÉ so s√°nh h·∫°n
                targetYear = systemCurrentDate.getFullYear();
            }

            console.log("H·ªá th·ªëng ƒëang ch·∫°y theo d·ªØ li·ªáu tu·∫ßn:", weekRes.data?.week_start);

            // B∆Ø·ªöC 2: T·∫£i c√°c d·ªØ li·ªáu c√≤n l·∫°i
            const [empRes, balRes, histRes, sourceRes] = await Promise.all([
                _supabase.from('employees').select('*').eq('code', userCode).single(),
                _supabase.from('leave_balance').select('*').eq('emp_code', userCode).eq('year', targetYear).maybeSingle(), 
                _supabase.from('leave_requests').select('*').eq('emp_code', userCode).order('created_at', { ascending: false }),
                _supabase.from('supplemental_leave').select('*').eq('emp_code', userCode).eq('type', 'NB').gt('amount', 0)
            ]);

			// [TH√äM M·ªöI] CHECK L·∫†I TR·∫†NG TH√ÅI NGAY KHI T·∫¢I
            if (empRes.data) {
                if (empRes.data.status === 'inactive') {
                    alert("T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã v√¥ hi·ªáu h√≥a.");
                    logout(); // T·ª± ƒë·ªông ƒëƒÉng xu·∫•t lu√¥n
                    return;
                }
                
                document.getElementById("dispName").innerText = empRes.data.name;
                document.getElementById("dispRole").innerText = empRes.data.role || "Nh√¢n vi√™n";
            }

            // 2. Hi·ªÉn th·ªã th√¥ng tin nh√¢n vi√™n
            if (empRes.data) {
                document.getElementById("dispName").innerText = empRes.data.name;
                document.getElementById("dispRole").innerText = empRes.data.role || "Nh√¢n vi√™n";
            }

            // 3. X·ª¨ L√ù S·ªê D∆Ø (LOGIC M·ªöI ·ªû ƒê√ÇY)
            let pOld = 0, pNew = 0, bOld = 0, bNew = 0;

            if (balRes.data) {
                pNew = Number(balRes.data.pn_val) || 0;     
                bNew = Number(balRes.data.nb_val) || 0;     
                pOld = Number(balRes.data.pn_old_val) || 0; 
                bOld = Number(balRes.data.nb_old_val) || 0; 
            }

            // --- ƒêO·∫†N CODE TH√äM M·ªöI ƒê·ªÇ X·ª¨ L√ù H·∫æT H·∫†N ---
            if (empRes.data) {
                // L·∫•y ng√†y h·∫øt h·∫°n t·ª´ th√¥ng tin nh√¢n vi√™n
                // L∆∞u √Ω: C·∫ßn ƒë·∫£m b·∫£o trong b·∫£ng 'employees' c√≥ c·ªôt 'pn_expire' v√† 'nb_expire'
                const pnExpireDate = empRes.data.pn_expire ? new Date(empRes.data.pn_expire) : null;
                const nbExpireDate = empRes.data.nb_expire ? new Date(empRes.data.nb_expire) : null;

                // Logic 1: N·∫øu tu·∫ßn hi·ªán t·∫°i > h·∫°n ph√©p nƒÉm -> Ph√©p nƒÉm c≈© = 0
                if (pnExpireDate && systemCurrentDate > pnExpireDate) {
                    console.log(`ƒê√£ qu√° h·∫°n ph√©p nƒÉm (${empRes.data.pn_expire}). Reset ph√©p c≈© v·ªÅ 0.`);
                    pOld = 0;
                }

                // Logic 2: N·∫øu tu·∫ßn hi·ªán t·∫°i > h·∫°n ngh·ªâ b√π -> B√π nƒÉm c≈© = 0
                if (nbExpireDate && systemCurrentDate > nbExpireDate) {
                    console.log(`ƒê√£ qu√° h·∫°n ngh·ªâ b√π (${empRes.data.nb_expire}). Reset b√π c≈© v·ªÅ 0.`);
                    bOld = 0;
                }
            }
            // ---------------------------------------------

            // C·∫≠p nh·∫≠t nh√£n hi·ªÉn th·ªã
            document.getElementById("currentYearDisp").innerText = targetYear;
            document.getElementById("lblPOld").innerText = `Ph√©p ${targetYear - 1}`;
            document.getElementById("lblPNew").innerText = `Ph√©p ${targetYear}`;
            document.getElementById("lblBOld").innerText = `B√π ${targetYear - 1}`;
            document.getElementById("lblBNew").innerText = `B√π ${targetYear}`;

            // 4. TR·ª™ ƒêI C√ÅC ƒê∆†N "CH·ªú DUY·ªÜT"
            let pendingP = 0;
            let pendingNB = 0;

            if (histRes.data) {
                histRes.data.forEach(req => {
                    if (req.status === 'Ch·ªù duy·ªát') {
                        let val = req.val || (req.type.includes("/2") ? 0.5 : 1.0);
                        if (req.type.startsWith("P")) pendingP += val;
                        if (req.type.startsWith("NB")) pendingNB += val;
                    }
                });
            }

            // Logic tr·ª´ hi·ªÉn th·ªã (kh√¥ng thay ƒë·ªïi)
            let displayPOld = pOld;
            let displayPNew = pNew;
            if (displayPOld >= pendingP) {
                displayPOld -= pendingP;
            } else {
                let remain = pendingP - displayPOld;
                displayPOld = 0;
                displayPNew = Math.max(0, displayPNew - remain);
            }

            let displayBOld = bOld;
            let displayBNew = bNew;
            if (displayBOld >= pendingNB) {
                displayBOld -= pendingNB;
            } else {
                let remain = pendingNB - displayBOld;
                displayBOld = 0;
                displayBNew = Math.max(0, displayBNew - remain);
            }

            // 5. G√ÅN S·ªê LI·ªÜU L√äN GIAO DI·ªÜN
            /*document.getElementById("valPOld").innerText = parseFloat(displayPOld.toFixed(2));
            document.getElementById("valPNew").innerText = parseFloat(displayPNew.toFixed(2));
            document.getElementById("valBOld").innerText = parseFloat(displayBOld.toFixed(2));
            document.getElementById("valBNew").innerText = parseFloat(displayBNew.toFixed(2));*/
            
			// G√°n gi√° tr·ªã hi·ªÉn th·ªã
			document.getElementById("valPOld").innerText = parseFloat(displayPOld.toFixed(1));
			document.getElementById("valPNew").innerText = parseFloat(displayPNew.toFixed(1));
			document.getElementById("valBOld").innerText = parseFloat(displayBOld.toFixed(1));
			document.getElementById("valBNew").innerText = parseFloat(displayBNew.toFixed(1));

			// --- LOGIC ·∫®N/HI·ªÜN TH·∫∫ NƒÇM C≈® KHI GI√Å TR·ªä = 0 ---
			
			// ·∫®n/Hi·ªán Ph√©p NƒÉm C≈©
			const cardPOld = document.getElementById("cardPOld");
			if (cardPOld) {
				// N·∫øu > 0 th√¨ hi·ªÉn th·ªã (reset style), n·∫øu = 0 th√¨ ·∫©n ƒëi
				cardPOld.style.display = (displayPOld > 0) ? '' : 'none';
			}
			
			// ·∫®n/Hi·ªán B√π NƒÉm C≈©
			const cardBOld = document.getElementById("cardBOld");
			if (cardBOld) {
				// N·∫øu > 0 th√¨ hi·ªÉn th·ªã (reset style), n·∫øu = 0 th√¨ ·∫©n ƒëi
				cardBOld.style.display = (displayBOld > 0) ? '' : 'none';
			}
			
            const grandTotal = displayPOld + displayPNew + displayBOld + displayBNew;
            document.getElementById("valTotal").innerText = parseFloat(grandTotal.toFixed(2));
            
            if (pendingP > 0 || pendingNB > 0) {
                document.getElementById("valTotal").style.color = "#f39c12"; 
                document.getElementById("valTotal").title = `ƒêang c√≥ ${pendingP + pendingNB} c√¥ng ch·ªù duy·ªát`;
            } else {
                document.getElementById("valTotal").style.color = "#d35400";
            }

            // 6. RENDER CHECKLIST (Gi·ªØ nguy√™n ph·∫ßn c√≤n l·∫°i)
            const listDiv = document.getElementById("sourceList");
            listDiv.innerHTML = "";
            
            if(sourceRes.data && sourceRes.data.length > 0) {
                sourceRes.data.forEach(src => {
                    let usedAmount = 0;
                    const d = new Date(src.date);
                    const dStr = `${d.getDate()}/${d.getMonth()+1}`;
                    const signature = `${dStr} (${src.reason})`;

                    if (histRes.data) {
                        histRes.data.forEach(req => {
                            if (req.status !== 'T·ª´ ch·ªëi' && req.reason && req.reason.includes(signature)) {
                                if (req.type === 'NB/2' || req.type.includes("0.5")) usedAmount += 0.5;
                                else if (req.type === 'NB') usedAmount += 1.0;
                            }
                        });
                    }

                    const remaining = parseFloat(src.amount) - usedAmount;
                    
                    if (remaining > 0) {
                        const item = document.createElement("div");
                        item.className = "source-item";
                        item.onclick = function(e) {
                            if (e.target.type !== 'checkbox') {
                                const cb = this.querySelector('input');
                                cb.checked = !cb.checked;
                                calcTotalDays(); 
                            }
                        };
                        const valDisplay = remaining < 1 ? `C√≤n: ${remaining} (√çt)` : `C√≤n: ${remaining}`;
                        const colorStyle = remaining < 1 ? "color:#e67e22;" : "color:#27ae60;";

                        item.innerHTML = `
                            <div style="display:flex; align-items:center;">
                                <input type="checkbox" class="src-cb" value="${signature}" data-amt="${remaining}" onchange="calcTotalDays()">
                                <div class="source-info">
                                    <span class="source-date">${dStr} - ${src.reason}</span>
                                    <span class="source-val" style="${colorStyle}">${valDisplay}</span>
                                </div>
                            </div>
                        `;
                        listDiv.appendChild(item);
                    }
                });
            } else {
                listDiv.innerHTML = '<div style="padding:15px; text-align:center; color:#999;">B·∫°n kh√¥ng c√≥ ng√†y c√¥ng b√π n√†o kh·∫£ d·ª•ng.</div>';
            }
            
            // L∆∞u d·ªØ li·ªáu v√†o bi·∫øn to√†n c·ª•c
            globalHistoryData = histRes.data || [];
            // G·ªçi h√†m render v·ªõi tham s·ªë false (nghƒ©a l√† ch∆∞a xem full, ch·ªâ hi·ªán 5)
            renderHistory(globalHistoryData, false);
            calcTotalDays();

        } catch(e) { 
            console.error(e); 
            alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.message);
        } finally { 
            document.getElementById("loading").style.display = "none"; 
        }
    }

    function renderHistory(data, isFullView) {
        const list = document.getElementById("historyList");
        const btnContainer = document.getElementById("viewMoreContainer");
        list.innerHTML = "";
        
        if (!data || data.length === 0) {
            list.innerHTML = "<div style='text-align:center; color:#999; padding:10px;'>Ch∆∞a c√≥ l·ªãch s·ª≠.</div>";
            btnContainer.style.display = "none";
            return;
        }

        // --- C·∫§U H√åNH LOGIC HI·ªÇN TH·ªä ---
        let displayData = data;
        const limit = 5;
        
        // Style chung cho n√∫t b·∫•m (ƒë·ªÉ ƒë·ªìng b·ªô giao di·ªán)
        const btnStyle = "background: white; border: 1px solid #0078d4; color: #0078d4; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px;";

        if (data.length > limit) {
            btnContainer.style.display = "block"; // Lu√¥n hi·ªán container n·∫øu > 5 d√≤ng

            if (!isFullView) {
                // TR∆Ø·ªúNG H·ª¢P 1: CH∆ØA XEM FULL -> C·∫Øt 5 d√≤ng, hi·ªán n√∫t Xem th√™m
                displayData = data.slice(0, limit);
                btnContainer.innerHTML = `
                    <button onclick="renderHistory(globalHistoryData, true)" style="${btnStyle}">
                        ‚Üì Xem to√†n b·ªô l·ªãch s·ª≠ c≈© h∆°n (${data.length - limit} c√≤n l·∫°i)
                    </button>`;
            } else {
                // TR∆Ø·ªúNG H·ª¢P 2: ƒêANG XEM FULL -> Hi·ªán h·∫øt, hi·ªán n√∫t Thu g·ªçn
                displayData = data; 
                btnContainer.innerHTML = `
                    <button onclick="renderHistory(globalHistoryData, false)" style="${btnStyle}">
                        ‚Üë Thu g·ªçn danh s√°ch
                    </button>`;
            }
        } else {
            // √çt h∆°n 5 d√≤ng th√¨ ·∫©n n√∫t ƒëi
            btnContainer.style.display = "none";
        }

        // --- V·∫º DANH S√ÅCH ---
        displayData.forEach(h => {
            let statusCls = "st-Cho";
            let btnCancel = "";
            let stText = h.status;

            if(h.status === "ƒê√£ duy·ªát") statusCls = "st-Duyet";
            if(h.status === "T·ª´ ch·ªëi") { statusCls = "st-TuChoi"; stText = "ƒê√£ t·ª´ ch·ªëi"; }
            if(h.status === "Ch·ªù duy·ªát") btnCancel = `<button class="btn-cancel" onclick="cancelRequest(${h.id})">H·ªßy Y√™u C·∫ßu</button>`;

            const d = new Date(h.date);
            const dateStr = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;

            list.innerHTML += `
                <li class="history-item ${statusCls}">
                    <div>
                        <span class="h-date">${dateStr} <span class="h-type">${h.type}</span></span>
                        <span style="font-size:13px; color:#555;">${h.reason || ''}</span>
                    </div>
                    <div style="text-align:right;">
                        <span class="h-status">${stText}</span><br>
                        ${btnCancel}
                    </div>
                </li>`;
        });
    }

    // --- H√ÄM T√çNH TO√ÅN ---
    function calcTotalDays() {
        const type = document.getElementById("reqType").value;
        const startStr = document.getElementById("reqStartDate").value;
        const endStr = document.getElementById("reqEndDate").value;
        const infoDiv = document.getElementById("calcInfo");
        const groupNb = document.getElementById("groupNbSource");
        
        // 1. ·∫®n/Hi·ªán Checklist
        if (type.startsWith("NB")) {
            groupNb.style.display = "block";
        } else {
            groupNb.style.display = "none";
            document.querySelectorAll(".src-cb").forEach(cb => cb.checked = false); 
        }

        // 2. T√≠nh s·ªë ng√†y
        if (!startStr) {
            infoDiv.style.display = "none";
            globalNeededTotal = 0;
            updateSourceStatus(0);
            return;
        }

        const d1 = new Date(startStr);
        const d2 = endStr ? new Date(endStr) : new Date(startStr);

        if (d2 < d1) {
            infoDiv.style.display = "block"; infoDiv.innerText = "‚ö†Ô∏è Ng√†y k·∫øt th√∫c kh√¥ng ƒë∆∞·ª£c nh·ªè h∆°n ng√†y b·∫Øt ƒë·∫ßu!"; infoDiv.style.color = "red";
            globalNeededTotal = 0; return;
        }

        const diffTime = Math.abs(d2 - d1);
        const dayCount = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
        const valPerDay = type.includes("/2") ? 0.5 : 1.0;
        globalNeededTotal = dayCount * valPerDay;

        // 3. Hi·ªÉn th·ªã
        infoDiv.style.display = "block";
        infoDiv.style.color = "#0078d4";
        infoDiv.innerHTML = `‚è≥ B·∫°n ch·ªçn <b>${dayCount} ng√†y</b>. <br>üí∞ T·ªïng tr·ª´: <b>${globalNeededTotal}</b> c√¥ng (${type}).`;

        // 4. Update m√†u s·∫Øc Checklist
        if (type.startsWith("NB")) {
            updateSourceStatus(globalNeededTotal);
        }
    }

    function updateSourceStatus(needed) {
        const sumDiv = document.getElementById("sourceSummary");
        if(needed === 0) { sumDiv.innerText=""; return; }

        let selected = 0;
        document.querySelectorAll(".src-cb:checked").forEach(cb => {
            selected += parseFloat(cb.getAttribute("data-amt"));
        });

        if(selected === needed) {
            sumDiv.innerHTML = `‚úÖ ƒê√£ ch·ªçn: ${selected} / C·∫ßn: ${needed} (H·ª£p l·ªá)`;
            sumDiv.className = "source-summary status-ok";
        } else if (selected > needed) {
            sumDiv.innerHTML = `‚ö†Ô∏è D∆∞: ${selected} / C·∫ßn: ${needed} (B·ªè b·ªõt ƒëi)`;
            sumDiv.className = "source-summary status-lack";
        } else {
            sumDiv.innerHTML = `‚ùå Thi·∫øu: ${selected} / C·∫ßn: ${needed} (Ch·ªçn th√™m)`;
            sumDiv.className = "source-summary status-lack";
        }
    }

    // --- G·ª¨I Y√äU C·∫¶U ---
    async function submitRequest() {
        const userCode = sessionStorage.getItem("empUser");
        const empName = document.getElementById("dispName").innerText;
        const type = document.getElementById("reqType").value;
        const startStr = document.getElementById("reqStartDate").value;
        const endStr = document.getElementById("reqEndDate").value || startStr;
        let reasonInput = document.getElementById("reqReason").value.trim();

        if (!startStr) return alert("Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu!");
        if (globalNeededTotal <= 0) return alert("Ng√†y kh√¥ng h·ª£p l·ªá!");

        // Ki·ªÉm tra s·ªë d∆∞
        const pTotal = parseFloat(document.getElementById("valTotal").innerText);
        const bOld = parseFloat(document.getElementById("valBOld").innerText) || 0;
        const bNew = parseFloat(document.getElementById("valBNew").innerText) || 0;
        const bTotal = bOld + bNew;
        const pOld = parseFloat(document.getElementById("valPOld").innerText) || 0;
        const pNew = parseFloat(document.getElementById("valPNew").innerText) || 0;
        const pnTotal = pOld + pNew;

        if (type.startsWith("P") && pnTotal < globalNeededTotal) {
            return alert(`S·ªë d∆∞ Ph√©p (${pnTotal}) kh√¥ng ƒë·ªß ƒë·ªÉ ngh·ªâ ${globalNeededTotal} c√¥ng.`);
        }
        if (type.startsWith("NB") && bTotal < globalNeededTotal) {
            return alert(`S·ªë d∆∞ B√π (${bTotal}) kh√¥ng ƒë·ªß ƒë·ªÉ ngh·ªâ ${globalNeededTotal} c√¥ng.`);
        }

        // --- KI·ªÇM TRA LOGIC NGU·ªíN B√ô (C·∫¨P NH·∫¨T M·ªöI) ---
        let finalReasonBase = reasonInput;
        if (type.startsWith("NB")) {
            let selected = 0;
            let sources = [];
            document.querySelectorAll(".src-cb:checked").forEach(cb => {
                selected += parseFloat(cb.getAttribute("data-amt"));
                sources.push(cb.value);
            });

            // 1. N·∫øu CH·ªåN THI·∫æU
            if (selected < globalNeededTotal) {
                return alert(`‚ö†Ô∏è B·∫°n CH∆ØA CH·ªåN ƒê·ª¶ ngu·ªìn b√π!\n- C·∫ßn: ${globalNeededTotal}\n- ƒê√£ ch·ªçn: ${selected}\nüëâ Vui l√≤ng tick th√™m v√†o danh s√°ch.`);
            }
            
            // 2. N·∫øu CH·ªåN TH·ª™A (D∆Ø)
            if (selected > globalNeededTotal) {
                return alert(`‚ö†Ô∏è B·∫°n CH·ªåN TH·ª™A ngu·ªìn b√π!\n- C·∫ßn: ${globalNeededTotal}\n- ƒê√£ ch·ªçn: ${selected}\nüëâ Vui l√≤ng b·ªè b·ªõt tick.`);
            }

            // 3. N·∫øu B·∫∞NG NHAU -> OK
            finalReasonBase = `[B√π cho: ${sources.join(", ")}] ${reasonInput}`;
        }

        if (!confirm(`X√°c nh·∫≠n ƒëƒÉng k√Ω ngh·ªâ t·ª´ ${startStr} ƒë·∫øn ${endStr}?\nT·ªïng: ${globalNeededTotal} c√¥ng.`)) return;

        const btn = document.querySelector(".btn-submit");
        btn.innerText = "ƒêang x·ª≠ l√Ω..."; btn.disabled = true;

        try {
			// [TH√äM M·ªöI] Check tr·∫°ng th√°i l·∫ßn cu·ªëi tr∆∞·ªõc khi insert
            const checkEmp = await _supabase.from('employees').select('status').eq('code', userCode).single();
            if (checkEmp.data && checkEmp.data.status === 'inactive') {
                alert("B·∫°n ƒë√£ ngh·ªâ vi·ªác, kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu!");
                logout();
                return;
            }
		
            const requests = [];
            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            const valPerDay = type.includes("/2") ? 0.5 : 1.0;

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateISO = d.toISOString().split('T')[0];
                requests.push({
                    emp_code: userCode, emp_name: empName, type: type, date: dateISO,
                    reason: finalReasonBase, status: 'Ch·ªù duy·ªát', val: valPerDay
                });
            }

            const { error } = await _supabase.from('leave_requests').insert(requests);

            if (error) throw error;

            alert("‚úÖ ƒê√£ g·ª≠i th√†nh c√¥ng " + requests.length + " y√™u c·∫ßu.");
            document.getElementById("reqStartDate").value = "";
            document.getElementById("reqEndDate").value = "";
            document.getElementById("reqReason").value = "";
            document.getElementById("calcInfo").style.display = "none";
            document.querySelectorAll(".src-cb").forEach(cb => cb.checked = false);
            
            loadData(userCode);

        } catch(e) { console.error(e); alert("L·ªói: " + e.message); } 
        finally { btn.innerText = "G·ª≠i Y√™u C·∫ßu"; btn.disabled = false; }
    }

    async function cancelRequest(id) {
        if(!confirm("H·ªßy y√™u c·∫ßu n√†y?")) return;
        document.getElementById("loading").style.display = "block";
        const userCode = sessionStorage.getItem("empUser");
        try {
            const { error } = await _supabase.from('leave_requests').delete().eq('id', id);
            if (error) throw error;
            alert("ƒê√£ h·ªßy!"); loadData(userCode);
        } catch(e) { alert("L·ªói: " + e.message); }
        document.getElementById("loading").style.display = "none";
    }

    function setupRealtimeListener(userCode) {
        _supabase.channel('employee-updates')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'leave_requests', filter: `emp_code=eq.${userCode}` }, 
            (payload) => {
                const status = payload.new.status;
                let msg = status === 'ƒê√£ duy·ªát' ? "‚úÖ ƒê∆°n ngh·ªâ ƒë√£ ƒë∆∞·ª£c duy·ªát!" : (status === 'T·ª´ ch·ªëi' ? "‚ùå ƒê∆°n ngh·ªâ b·ªã t·ª´ ch·ªëi." : "üîî Tr·∫°ng th√°i ƒë∆°n thay ƒë·ªïi.");
                playNotificationSound(); showToastNotification(msg); loadData(userCode);
            })
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'leave_balance', filter: `emp_code=eq.${userCode}` }, 
            () => { playNotificationSound(); showToastNotification("üí∞ S·ªë d∆∞ ph√©p thay ƒë·ªïi!"); loadData(userCode); })
            .subscribe();
    }

    function playNotificationSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator(); const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = "sine"; osc.frequency.setValueAtTime(800, ctx.currentTime);
        gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        osc.start(); osc.stop(ctx.currentTime + 0.5);
    }

    function showToastNotification(mess) {
        const div = document.createElement("div");
        div.style.position = "fixed"; div.style.top = "20px"; div.style.right = "20px";
        div.style.background = "#2c3e50"; div.style.color = "white"; div.style.padding = "15px 25px";
        div.style.borderRadius = "50px"; div.style.boxShadow = "0 4px 15px rgba(0,0,0,0.2)";
        div.style.zIndex = "9999"; div.style.fontWeight = "bold"; div.style.animation = "slideInRight 0.5s forwards";
        div.innerText = mess; document.body.appendChild(div);
        setTimeout(() => { div.style.opacity = "0"; div.style.transition="opacity 0.5s"; setTimeout(()=>div.remove(),500); }, 5000);
    }
    
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }`;
    document.head.appendChild(styleSheet);
</script>

</body>
</html>
