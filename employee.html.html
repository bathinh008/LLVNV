<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C·ªïng Nh√¢n Vi√™n</title>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
    
    /* Header */
    .header { background: #0078d4; color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .header h2 { margin: 0; font-size: 22px; }
    .header p { margin: 5px 0 0; opacity: 0.9; }
    .btn-logout { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px; font-size: 12px; }

    /* Container */
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }

    /* Cards S·ªë D∆∞ */
    .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
    .card h4 { margin: 0 0 5px; color: #666; font-size: 14px; }
    .card .value { font-size: 24px; font-weight: bold; color: #333; }
    .card.old { border-bottom: 3px solid #f1c40f; } /* M√†u v√†ng cho nƒÉm c≈© */
    .card.new { border-bottom: 3px solid #2ecc71; } /* M√†u xanh cho nƒÉm m·ªõi */

    /* Form ƒêƒÉng k√Ω */
    .action-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px; }
    .action-box h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #0078d4; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #444; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
    .btn-submit { width: 100%; padding: 12px; background: #0078d4; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-submit:active { transform: scale(0.98); }

    /* L·ªãch s·ª≠ */
    .history-list { list-style: none; padding: 0; }
    .history-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #ddd; }
    .history-item.st-Cho { border-left-color: #f39c12; }
    .history-item.st-Duyet { border-left-color: #2ecc71; }
    .h-date { font-weight: bold; display: block; }
    .h-type { font-size: 12px; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; margin-left: 5px;}
    .h-status { font-size: 12px; font-weight: bold; color: #888; }
    
    .btn-cancel { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-top: 5px; }

    /* Loading */
    #loading { text-align: center; padding: 20px; color: #666; display: none; }
</style>
</head>
<body>

<div id="loginScreen" style="height: 100vh; display: flex; align-items: center; justify-content: center; background: #eef2f5;">
    <div style="background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h2 style="color: #0078d4;">NH√ÇN VI√äN</h2>
        <input type="text" id="usernameInput" class="form-control" placeholder="Nh·∫≠p M√£ Nh√¢n Vi√™n (VD: SCC000001)" style="margin-bottom: 15px;" onkeypress="handleEnter(event)">
        <button onclick="doLogin()" class="btn-submit">Truy C·∫≠p</button>
    </div>
</div>

<div id="mainScreen" style="display: none;">
    <div class="header">
        <h2 id="dispName">ƒêang t·∫£i...</h2>
        <p id="dispRole">...</p>
        <button class="btn-logout" onclick="logout()">Tho√°t</button>
    </div>

    <div class="container">
        <h3 style="margin-top:0; color: #444;">S·ªë D∆∞ Ph√©p & B√π</h3>
        <div class="balance-grid">
            <div class="card old">
                <h4>Ph√©p NƒÉm C≈©</h4>
                <div class="value" id="valPOld">-</div>
            </div>
            <div class="card new">
                <h4>Ph√©p NƒÉm M·ªõi</h4>
                <div class="value" id="valPNew">-</div>
            </div>
            <div class="card old">
                <h4>Ngh·ªâ B√π C≈©</h4>
                <div class="value" id="valBOld">-</div>
            </div>
            <div class="card new">
                <h4>Ngh·ªâ B√π M·ªõi</h4>
                <div class="value" id="valBNew">-</div>
            </div>
            <div class="card" style="grid-column: span 2; background: #fff3cd; border-bottom: none;">
                <h4 style="color: #d35400;">T·ªîNG NG√ÄY NGH·ªà C√ì TH·ªÇ S·ª¨ D·ª§NG</h4>
                <div class="value" id="valTotal" style="color: #d35400;">-</div>
            </div>
        </div>

        <div class="action-box">
            <h3>üìÖ ƒêƒÉng K√Ω Ngh·ªâ</h3>
            
            <div class="form-group">
                <label>Lo·∫°i ngh·ªâ</label>
                <select id="reqType" class="form-control" onchange="toggleReasonType()">
                    <option value="P">Ngh·ªâ Ph√©p (P)</option>
                    <option value="P/2">Ngh·ªâ Ph√©p 0.5 (S√°ng/Chi·ªÅu)</option>
                    <option value="NB">Ngh·ªâ B√π (NB)</option>
                    <option value="NB/2">Ngh·ªâ B√π 0.5 (S√°ng/Chi·ªÅu)</option>
                </select>
            </div>

            <div class="form-group" id="groupNbSource" style="display:none; background: #e8f0fe; padding: 10px; border-radius: 8px;">
                <label style="color:#1967d2; font-size: 14px;">Ch·ªçn ng√†y c√¥ng mu·ªën b√π:</label>
                <select id="reqNbSource" class="form-control" style="margin-top: 5px;">
                    <option value="">-- ƒêang t·∫£i d·ªØ li·ªáu... --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ng√†y ngh·ªâ mong mu·ªën</label>
                <input type="date" id="reqDate" class="form-control">
            </div>
            
            <div class="form-group">
                <label>L√Ω do / Ghi ch√∫</label>
                <input type="text" id="reqReason" class="form-control" placeholder="Nh·∫≠p l√Ω do...">
            </div>
            
            <button onclick="submitRequest()" class="btn-submit">G·ª≠i Y√™u C·∫ßu</button>
        </div>

        <h3 style="color: #444;">L·ªãch s·ª≠ y√™u c·∫ßu</h3>
        <ul id="historyList" class="history-list">
        </ul>
    </div>
</div>

<div id="loading">ƒêang x·ª≠ l√Ω...</div>

<script>
    // C·∫§U H√åNH: Thay URL Web App c·ªßa b·∫°n v√†o ƒë√¢y
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxRJeVTiI0g1yp-ehdX_HCQpNog0aZ--HlYyqZ7qy6UWebJDVpwkqjLg3NDK56MwNSl/exec"; 
    
    // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
    const savedUser = localStorage.getItem("empUser");
    if (savedUser) {
        showMain(savedUser);
    }

    function handleEnter(e) {
        if (e.key === "Enter") doLogin();
    }

    function doLogin() {
        const user = document.getElementById("usernameInput").value.trim();
        if (!user) return alert("Vui l√≤ng nh·∫≠p m√£ nh√¢n vi√™n!");
        localStorage.setItem("empUser", user);
        showMain(user);
    }

    function logout() {
        localStorage.removeItem("empUser");
        location.reload();
    }

    function showMain(user) {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainScreen").style.display = "block";
        loadData(user);
    }

    async function loadData(user) {
        document.getElementById("loading").style.display = "block";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getEmployeeDetail&code=${encodeURIComponent(user)}`);
            const data = await res.json();
            
            if (!data.success) {
                alert(data.message || "L·ªói t·∫£i d·ªØ li·ªáu");
                logout(); return;
            }

            // Hi·ªÉn th·ªã th√¥ng tin
            const info = data.info;
            document.getElementById("dispName").innerText = info.name;
            document.getElementById("dispRole").innerText = info.role;

            const bal = data.balance;
            document.getElementById("valPOld").innerText = bal.pOld;
            document.getElementById("valPNew").innerText = bal.pNew;
            document.getElementById("valBOld").innerText = bal.bOld;
            document.getElementById("valBNew").innerText = bal.bNew;
            document.getElementById("valTotal").innerText = (bal.pOld + bal.pNew + bal.bOld + bal.bNew);

            // --- X·ª¨ L√ù DANH S√ÅCH NGU·ªíN B√ô (M·ªöI) ---
            let listNbSources = data.nbSources || [];
            const selSource = document.getElementById("reqNbSource");
            selSource.innerHTML = '<option value="">-- Ch·ªçn ng√†y c√¥ng mu·ªën b√π (T√πy ch·ªçn) --</option>';
            
            listNbSources.forEach(src => {
                const opt = document.createElement("option");
                const label = `${src.date} - ${src.reason}`;
                opt.value = label; 
                opt.innerText = `${label} (C√≤n ${src.amount})`;
                if (src.amount < 1) opt.style.color = "#d35400";
                selSource.appendChild(opt);
            });

            // --- X·ª¨ L√ù L·ªäCH S·ª¨ ---
            const list = document.getElementById("historyList");
            list.innerHTML = "";
            (data.history || []).forEach(h => {
                let statusCls = "st-Cho";
                let btnCancel = "";
                
                if(h.status === "ƒê√£ duy·ªát") statusCls = "st-Duyet";
                
                // Ch·ªâ hi·ªán n√∫t H·ªßy n·∫øu tr·∫°ng th√°i l√† "Ch·ªù duy·ªát"
                if(h.status === "Ch·ªù duy·ªát") {
                    btnCancel = `<button class="btn-cancel" onclick="cancelRequest('${h.date}', '${h.type}')">H·ªßy Y√™u C·∫ßu</button>`;
                }

                list.innerHTML += `
                    <li class="history-item ${statusCls}">
                        <div>
                            <span class="h-date">${h.date} <span class="h-type">${h.type}</span></span>
                            <span style="font-size:13px; color:#555;">${h.reason}</span>
                        </div>
                        <div style="text-align:right;">
                            <span class="h-status">${h.status}</span><br>
                            ${btnCancel}
                        </div>
                    </li>`;
            });

        } catch(e) { console.error(e); alert("L·ªói k·∫øt n·ªëi!"); } 
        finally { document.getElementById("loading").style.display = "none"; }
    }

    async function submitRequest() {
        const user = localStorage.getItem("empUser");
        const type = document.getElementById("reqType").value;
        const date = document.getElementById("reqDate").value;
        const name = document.getElementById("dispName").innerText;
        
        let reason = document.getElementById("reqReason").value.trim();
        const sourceVal = document.getElementById("reqNbSource").value;

        // N·∫øu c√≥ ch·ªçn ngu·ªìn b√π, t·ª± ƒë·ªông ƒëi·ªÅn v√†o l√Ω do
        if ((type === "NB" || type === "NB/2") && sourceVal) {
            reason = `[B√π cho: ${sourceVal}] ` + reason;
        }

        if (!date) return alert("Ch·ªçn ng√†y ngh·ªâ!");
        if (!confirm(`X√°c nh·∫≠n ƒëƒÉng k√Ω ngh·ªâ ${type} v√†o ng√†y ${date}?`)) return;

        const btn = document.querySelector(".btn-submit");
        const oldText = btn.innerText;
        btn.innerText = "ƒêang g·ª≠i..."; btn.disabled = true;

        const payload = {
            code: user,
            name: name,
            type: type,
            date: date,
            reason: reason 
        };

        try {
            await fetch(`${SCRIPT_URL}?action=submitLeaveRequest&data=` + encodeURIComponent(JSON.stringify(payload)));
            alert("ƒê√£ g·ª≠i y√™u c·∫ßu th√†nh c√¥ng!");
            document.getElementById("reqDate").value = "";
            document.getElementById("reqReason").value = "";
            document.getElementById("reqNbSource").value = ""; // Reset
            loadData(user);
        } catch(e) {
            alert("L·ªói khi g·ª≠i!");
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
    }

    // H√†m H·ªßy Y√™u C·∫ßu
    async function cancelRequest(dateStr, typeStr) {
        if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy y√™u c·∫ßu n√†y?")) return;
        
        const user = localStorage.getItem("empUser");
        document.getElementById("loading").style.display = "block";
        
        try {
            const res = await fetch(`${SCRIPT_URL}?action=cancelLeaveRequest&code=${user}&date=${encodeURIComponent(dateStr)}&type=${encodeURIComponent(typeStr)}`);
            const json = await res.json();
            alert(json.message);
            loadData(user); // T·∫£i l·∫°i danh s√°ch
        } catch(e) {
            alert("L·ªói k·∫øt n·ªëi!");
        } finally {
            document.getElementById("loading").style.display = "none";
        }
    }

    function toggleReasonType() {
        const type = document.getElementById("reqType").value;
        const group = document.getElementById("groupNbSource");
        if (type === "NB" || type === "NB/2") {
            group.style.display = "block";
        } else {
            group.style.display = "none";
            document.getElementById("reqNbSource").value = ""; 
        }
    }
</script>

</body>
</html>